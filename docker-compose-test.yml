version: '3'

services:
  app:
    build: ./api
    command: ./chat_back
    container_name: ${APP_CONTAINER_NAME}
    env_file:
      - .env.test
    ports:
      - "${APP_PORT}:8080"
  db:
    image: postgres:latest
    container_name: ${POSTGRES_CONTAINER_NAME}
    hostname: ${POSTGRES_HOSTNAME}
    ports:
      - "${POSTGRES_PORT}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB} 
    volumes:
      - db_store:/var/lib/postgresql/data
  db-dev:
    image: postgres:latest
    container_name: ${POSTGRES_CONTAINER_NAME_DEV}
    hostname: ${POSTGRES_HOSTNAME_DEV}
    ports:
      - "${POSTGRES_PORT_DEV}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB} 
    volumes:
      - db_store_dev:/var/lib/postgresql/data
  migrate:
    build: ./migration
    container_name: ${MIGRATION_CONTAINER_NAME}
    volumes:
      - ./db:/db:ro
    entrypoint: ["/bin/bash", "/app/wait-for-it.sh", "${POSTGRES_HOSTNAME}:5432", "--",
      "/bin/bash", "/app/wait-for-it.sh", "${POSTGRES_HOSTNAME_DEV}:5432", "--",
      "atlas", "schema", "apply",
      "--url", "${DATABASE_URL}",
      "--dev-url", "${DATABASE_URL_DEV}",
      "--to", "file:///db/schema.sql",
      "--auto-approve"
    ]
    depends_on:
      - db
      - db-dev

volumes:
  db_store:
    name: ${POSTGRES_VOLUME_NAME}
  db_store_dev:
    name: ${POSTGRES_VOLUME_NAME_DEV}
